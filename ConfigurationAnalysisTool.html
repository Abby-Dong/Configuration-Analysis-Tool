<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†åŸçµ„æ…‹åˆ†æå·¥å…· - å¢å¼·ç‰ˆ</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Inter å­—é«” -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* è¼‰å…¥å‹•ç•« */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        /* æ·¡å…¥å‹•ç•« */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        /* æ‹–æ”¾å€åŸŸæ¨£å¼ */
        #drop-zone.drag-over {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }
        /* æ”¶åˆç‹€æ…‹ */
        #drop-zone.collapsed {
            padding: 1rem;
            cursor: pointer;
        }
        #drop-zone.collapsed .drop-zone-full {
            display: none;
        }
        #drop-zone.collapsed .drop-zone-compact {
            display: flex;
        }
        #drop-zone .drop-zone-compact {
            display: none;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- æ¨™é¡Œå’Œæª”æ¡ˆä¸Šå‚³ -->
        <header class="mb-6">
            <div class="flex items-center justify-between mb-2">
                <h1 class="text-3xl font-bold text-slate-800">å•†åŸçµ„è£å“çµ„æ…‹åˆ†æå·¥å…·</h1>
                <div id="stats-badge" class="hidden bg-indigo-50 text-indigo-700 px-4 py-2 rounded-lg text-sm font-medium">
                    <span id="product-count">0</span> å€‹ç”¢å“ | <span id="component-count">0</span> å€‹å…ƒä»¶
                </div>
            </div>
            <p class="text-slate-600 mb-4">è«‹ä¸Šå‚³æ‚¨çš„çµ„æ…‹ CSV æª”æ¡ˆä»¥é–‹å§‹åˆ†æã€‚æ‰€æœ‰è™•ç†å‡åœ¨æ‚¨çš„ç€è¦½å™¨æœ¬æ©Ÿå®Œæˆï¼Œè³‡æ–™çµ•ä¸ä¸Šå‚³è‡³ä¼ºæœå™¨ã€‚</p>
            
            <!-- ç›¸ä¾ç›¸æ–¥è¦å‰‡ä¸Šå‚³æŒ‰éˆ• -->
            <div class="mb-4">
                <label for="compatibility-file-input" class="inline-flex items-center px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 cursor-pointer transition-colors shadow">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    åŒ¯å…¥ç›¸ä¾ç›¸æ–¥è¦å‰‡è¡¨ (é¸å¡«)
                </label>
                <input type="file" id="compatibility-file-input" accept=".csv" class="hidden"/>
                <span id="compatibility-file-status" class="ml-3 text-sm text-slate-500"></span>
            </div>
            
            <!-- æ‹–æ”¾å€åŸŸ -->
            <div id="drop-zone" class="bg-white p-8 rounded-lg shadow border-2 border-dashed border-slate-300 hover:border-indigo-400 transition-all cursor-pointer">
                <!-- å®Œæ•´é¡¯ç¤º -->
                <div class="drop-zone-full text-center">
                    <svg class="mx-auto h-12 w-12 text-slate-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <p class="text-lg font-medium text-slate-700 mb-2">æ‹–æ”¾ CSV æª”æ¡ˆåˆ°æ­¤è™•</p>
                    <p class="text-sm text-slate-500 mb-4">æˆ–</p>
                    <label for="file-input" class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 cursor-pointer transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        é»æ“Šé¸æ“‡æª”æ¡ˆ
                    </label>
                    <input type="file" id="file-input" accept=".csv" class="hidden"/>
                    <p class="mt-3 text-xs text-slate-500">æ”¯æ´æ ¼å¼ï¼šCSV (é€—è™Ÿåˆ†éš”å€¼)</p>
                </div>
                
                <!-- æ”¶åˆé¡¯ç¤º -->
                <div class="drop-zone-compact items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <svg class="h-8 w-8 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>
                            <p class="font-medium text-slate-800" id="uploaded-file-name">æª”æ¡ˆå·²ä¸Šå‚³</p>
                            <p class="text-sm text-slate-500">é»æ“Šé‡æ–°ä¸Šå‚³å…¶ä»–æª”æ¡ˆ</p>
                        </div>
                    </div>
                    <svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </div>
            </div>
            <!-- éŒ¯èª¤æç¤º -->
            <div id="error-alert" class="hidden mt-4 bg-red-50 border border-red-200 text-red-800 px-4 py-3 rounded-lg">
                <div class="flex">
                    <svg class="h-5 w-5 text-red-400 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                    <div>
                        <p class="font-medium">è™•ç†éŒ¯èª¤</p>
                        <p class="text-sm" id="error-message"></p>
                    </div>
                </div>
            </div>
        </header>

        <!-- è¼‰å…¥ä¸­æç¤º -->
        <div id="loading-indicator" class="hidden text-center p-12 bg-white rounded-lg shadow">
            <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-indigo-600 border-r-transparent mb-4"></div>
            <p class="text-lg font-medium text-slate-700">æ­£åœ¨åˆ†ææ‚¨çš„ CSV æª”æ¡ˆ...</p>
        </div>

        <!-- åˆ†æå…§å®¹å€åŸŸ -->
        <main id="analysis-content" class="hidden">
            <!-- åˆ†é å°è¦½ -->
            <nav class="flex flex-wrap border-b border-slate-300 mb-6" id="tabs">
                <button data-tab="overview" class="tab-button py-3 px-4 font-medium text-slate-600 border-b-2 border-indigo-500 text-indigo-600">
                    ç¸½è¦½
                </button>
                <button data-tab="complexity" class="tab-button py-3 px-4 font-medium text-slate-500 border-b-2 border-transparent hover:border-slate-400 hover:text-slate-700">
                    ç”¢å“çµ„æ…‹æ’è¡Œ
                </button>
                <button data-tab="commonality" class="tab-button py-3 px-4 font-medium text-slate-500 border-b-2 border-transparent hover:border-slate-400 hover:text-slate-700">
                    å­å…ƒä»¶é€šç”¨æ€§
                </button>
                <button data-tab="compatibility" class="tab-button py-3 px-4 font-medium text-slate-500 border-b-2 border-transparent hover:border-slate-400 hover:text-slate-700">
                    ç›¸ä¾ç›¸æ–¥è¦å‰‡
                </button>
            </nav>

            <!-- åˆ†é å…§å®¹ -->
            <div id="tab-content" class="fade-in">
                <!-- å…§å®¹å°‡ç”± JS å‹•æ…‹å¡«å…¥ -->
            </div>
        </main>
    </div>

    <!-- ç”¢å“è©³æƒ… Modal -->
    <div id="product-modal" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col">
            <header class="p-4 md:p-6 border-b border-slate-200 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-semibold text-slate-800" id="modal-product-name">ç”¢å“è©³æƒ…</h2>
                    <p class="text-sm text-slate-600 mt-1" id="modal-product-count">ç¸½çµ„æ…‹æ•¸é‡ï¼š0</p>
                </div>
                <button id="modal-close-button" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </header>
            <div class="p-4 md:p-6 overflow-y-auto no-scrollbar" id="modal-product-details"></div>
        </div>
    </div>

    <!-- å­å…ƒä»¶æŸ¥è©¢ Modal -->
    <div id="component-search-modal" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <header class="p-4 md:p-6 border-b border-slate-200 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-semibold text-slate-800">å­å…ƒä»¶æŸ¥è©¢</h2>
                    <p class="text-sm text-slate-600 mt-1">è¼¸å…¥å…ƒä»¶æ–™è™Ÿï¼ŒæŸ¥è©¢æ‰€æœ‰ä½¿ç”¨è©²å…ƒä»¶çš„ç”¢å“æ¸…å–®</p>
                </div>
                <button id="component-search-modal-close" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </header>
            <div class="p-4 md:p-6 overflow-y-auto no-scrollbar">
                <div class="mb-4">
                    <label for="component-search-input" class="block text-sm font-medium text-slate-700 mb-2">æœå°‹å…ƒä»¶</label>
                    <input 
                        type="text" 
                        id="component-search-input" 
                        placeholder="è¼¸å…¥å…ƒä»¶æ–™è™Ÿé€²è¡Œæœå°‹..." 
                        class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    />
                </div>

                <div class="mb-4">
                    <label for="component-search-select" class="block text-sm font-medium text-slate-700 mb-2">æˆ–å¾åˆ—è¡¨é¸æ“‡</label>
                    <select id="component-search-select" class="w-full p-3 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">-- è«‹é¸æ“‡å…ƒä»¶ --</option>
                    </select>
                </div>

                <div id="component-search-results" class="mt-6"></div>
            </div>
        </div>
    </div>

    <script>
        // ==================== å¸¸æ•¸å®šç¾© ====================
        const COLUMN_DEFINITIONS = {
            PRODUCT_KEY: 'Product',
            BASE: [
                'Base Modules',
                'Expansion Modules (Left Side)',
                'EtherCAT Slice IO  (Right Side)'
            ],
            COMPONENT: [
                'Processors',
                'Memory',
                'Storage',
                'NVRAM Module',
                'OS',
                'Software',
                'Expansion I/O'
            ],
            ADD_ON: [
                'Accessories(MC)'
            ]
        };

        const EMPTY_VALUES = ['', '-', 'N/A', 'n/a', 'NA', 'null', 'NULL'];

        // ==================== å…¨åŸŸè®Šæ•¸ ====================
        let allProductsData = {};
        let productConfigAnalysis = [];
        let componentCommonality = [];
        let rawCSVData = [];
        let compatibilityRules = []; // å„²å­˜ç›¸ä¾ç›¸æ–¥è¦å‰‡

        // ==================== DOM å…ƒç´  ====================
        const fileInput = document.getElementById('file-input');
        const dropZone = document.getElementById('drop-zone');
        const uploadedFileName = document.getElementById('uploaded-file-name');
        const loadingIndicator = document.getElementById('loading-indicator');
        const analysisContent = document.getElementById('analysis-content');
        const tabContainer = document.getElementById('tabs');
        const tabContent = document.getElementById('tab-content');
        const errorAlert = document.getElementById('error-alert');
        const errorMessage = document.getElementById('error-message');
        const statsBadge = document.getElementById('stats-badge');
        const productCountSpan = document.getElementById('product-count');
        const componentCountSpan = document.getElementById('component-count');
        
        // ç›¸ä¾ç›¸æ–¥è¦å‰‡ç›¸é—œå…ƒç´ 
        const compatibilityFileInput = document.getElementById('compatibility-file-input');
        const compatibilityFileStatus = document.getElementById('compatibility-file-status');

        // Modal å…ƒç´ 
        const productModal = document.getElementById('product-modal');
        const modalProductName = document.getElementById('modal-product-name');
        const modalProductCount = document.getElementById('modal-product-count');
        const modalProductDetails = document.getElementById('modal-product-details');
        const modalCloseButton = document.getElementById('modal-close-button');

        // å­å…ƒä»¶æŸ¥è©¢ Modal å…ƒç´ 
        const componentSearchModal = document.getElementById('component-search-modal');
        const componentSearchModalClose = document.getElementById('component-search-modal-close');
        const componentSearchInput = document.getElementById('component-search-input');
        const componentSearchSelect = document.getElementById('component-search-select');
        const componentSearchResults = document.getElementById('component-search-results');

        // ==================== å·¥å…·å‡½å¼ ====================

        /**
         * é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
         */
        function showError(message) {
            errorMessage.textContent = message;
            errorAlert.classList.remove('hidden');
            setTimeout(() => errorAlert.classList.add('hidden'), 5000);
        }

        /**
         * éš±è—éŒ¯èª¤è¨Šæ¯
         */
        function hideError() {
            errorAlert.classList.add('hidden');
        }

        /**
         * åˆ¤æ–·å€¼æ˜¯å¦ç‚ºç©º
         */
        function isEmpty(value) {
            if (!value) return true;
            const trimmed = String(value).trim();
            return EMPTY_VALUES.includes(trimmed);
        }

        /**
         * è§£æç›¸ä¾ç›¸æ–¥è¦å‰‡ CSV
         * æ–°æ ¼å¼ï¼šModel åˆ—è¡¨ + First-Product çµ„ + Second-Product çµ„ + Type
         */
        function parseCompatibilityRules(csvText) {
            compatibilityRules = [];
            
            // å…ˆè™•ç†è·¨è¡Œçš„å¼•è™Ÿå­—ä¸²
            const lines = [];
            const rawLines = csvText.split(/\r?\n/);
            let i = 0;
            
            while (i < rawLines.length) {
                let line = rawLines[i];
                
                // å¦‚æœé€™ä¸€è¡ŒåŒ…å«æœªé–‰åˆçš„å¼•è™Ÿï¼Œç¹¼çºŒè®€å–ä¸‹ä¸€è¡Œ
                if (line.trim() !== '') {
                    let quoteCount = (line.match(/"/g) || []).length;
                    
                    // å¦‚æœå¼•è™Ÿæ•¸é‡æ˜¯å¥‡æ•¸ï¼Œè¡¨ç¤ºè·¨è¡Œ
                    while (quoteCount % 2 !== 0 && i + 1 < rawLines.length) {
                        i++;
                        line += '\n' + rawLines[i];
                        quoteCount = (line.match(/"/g) || []).length;
                    }
                    
                    lines.push(line);
                }
                i++;
            }
            
            console.log(`åˆä½µå¾Œå…± ${lines.length} è¡Œæœ‰æ•ˆè³‡æ–™`);
            
            if (lines.length < 2) {
                throw new Error("ç›¸ä¾ç›¸æ–¥è¦å‰‡è¡¨ç‚ºç©ºæˆ–åªæœ‰æ¨™é ­");
            }

            // è§£ææ¨™é ­
            const headers = parseCSVLine(lines[0]);
            console.log('CSV æ¨™é ­:', headers);
            
            // æ‰¾åˆ°é—œéµæ¬„ä½ç´¢å¼•
            const modelIndex = headers.findIndex(h => h.trim() === 'Model');
            const typeIndex = headers.findIndex(h => h.trim() === 'Type');
            
            if (modelIndex === -1 || typeIndex === -1) {
                throw new Error(`CSV ç¼ºå°‘å¿…è¦æ¬„ä½ï¼š${modelIndex === -1 ? 'Model' : 'Type'}`);
            }
            
            // å‹•æ…‹å°‹æ‰¾ First-Product å’Œ Second-Product æ¬„ä½
            const firstProductIndices = [];
            const secondProductIndices = [];
            
            headers.forEach((header, index) => {
                const h = header.trim();
                console.log(`æª¢æŸ¥æ¨™é ­ [${index}]: "${h}"`);
                
                // åŒ¹é… "First-Product 1", "First-Product 2", "First-Product 3"
                // æ”¯æ´ First-Product æˆ– First Productï¼Œä¸­é–“ç©ºæ ¼æ•¸é‡ä¸é™
                if (/^First[-\s]*Product\s+\d+$/i.test(h)) {
                    console.log(`  âœ“ åŒ¹é…ç‚º First-Product`);
                    firstProductIndices.push(index);
                }
                // åŒ¹é… "Second-Product 1", "Second-Product 2", "Second-Product 3"
                else if (/^Second[-\s]*Product\s+\d+$/i.test(h)) {
                    console.log(`  âœ“ åŒ¹é…ç‚º Second-Product`);
                    secondProductIndices.push(index);
                }
            });
            
            console.log('First-Product æ¬„ä½ç´¢å¼•:', firstProductIndices);
            console.log('Second-Product æ¬„ä½ç´¢å¼•:', secondProductIndices);
            
            if (firstProductIndices.length === 0) {
                console.warn('è­¦å‘Šï¼šæœªæ‰¾åˆ° First-Product ç›¸é—œæ¬„ä½');
            }
            if (secondProductIndices.length === 0) {
                console.warn('è­¦å‘Šï¼šæœªæ‰¾åˆ° Second-Product ç›¸é—œæ¬„ä½');
            }

            // è§£æè³‡æ–™è¡Œ
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                
                console.log(`\nç¬¬ ${i} è¡Œè§£æçµæœ (${values.length} å€‹æ¬„ä½):`, values);
                
                // è®€å– Model æ¬„ä½ï¼ˆåŒ…å«å¤šå€‹ç”¢å“ï¼Œç”¨é€—è™Ÿå’Œæ›è¡Œåˆ†éš”ï¼‰
                const modelText = values[modelIndex]?.trim() || '';
                
                // è™•ç† Model æ¬„ä½ï¼šç§»é™¤å¤–å±¤å¼•è™Ÿ
                let cleanedModelText = modelText;
                if (cleanedModelText.startsWith('"') && cleanedModelText.endsWith('"')) {
                    cleanedModelText = cleanedModelText.slice(1, -1);
                }
                
                // åˆ†å‰²ç”¢å“åç¨±ï¼ˆç”¨é€—è™Ÿæˆ–æ›è¡Œåˆ†éš”ï¼‰
                const models = cleanedModelText
                    .split(/[,\n]+/)
                    .map(m => {
                        const trimmed = m.trim();
                        // ç§»é™¤ IMVirtue_ å‰ç¶´ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        return trimmed.replace(/^IMVirtue_/i, '');
                    })
                    .filter(m => m && !isEmpty(m));
                
                console.log(`è§£æåˆ° ${models.length} å€‹é©ç”¨ç”¢å“:`, models.slice(0, 3), models.length > 3 ? '...' : '');
                
                // è®€å– Type
                const type = values[typeIndex]?.trim();
                console.log(`Type (æ¬„ä½ ${typeIndex}): "${type}"`);
                
                if (!type || (type !== 'Mandatory' && type !== 'Incompatible')) {
                    console.log(`ç¬¬ ${i} è¡Œè·³éï¼šType ç„¡æ•ˆæˆ–ç‚ºç©º (å€¼: "${type}")`);
                    continue;
                }
                
                // è®€å– First-Product çµ„
                const firstGroup = [];
                firstProductIndices.forEach((idx, index) => {
                    const val = values[idx]?.trim();
                    console.log(`  First-Product ${index + 1} (æ¬„ä½ ${idx}): "${val}"`);
                    if (val && !isEmpty(val)) {
                        firstGroup.push(val);
                    }
                });
                console.log(`First Group (${firstGroup.length} é …):`, firstGroup);
                
                // è®€å– Second-Product çµ„
                const secondGroup = [];
                secondProductIndices.forEach((idx, index) => {
                    const val = values[idx]?.trim();
                    console.log(`  Second-Product ${index + 1} (æ¬„ä½ ${idx}): "${val}"`);
                    if (val && !isEmpty(val)) {
                        secondGroup.push(val);
                    }
                });
                console.log(`Second Group (${secondGroup.length} é …):`, secondGroup);
                
                // åªæœ‰ç•¶ First Group å’Œ Second Group éƒ½æœ‰è³‡æ–™æ™‚æ‰åŠ å…¥è¦å‰‡
                if (firstGroup.length > 0 && secondGroup.length > 0 && models.length > 0) {
                    console.log(`âœ… ç¬¬ ${i} è¡Œè¦å‰‡æœ‰æ•ˆï¼š${models.length} å€‹ç”¢å“é©ç”¨æ­¤è¦å‰‡`);
                    compatibilityRules.push({
                        models: models,
                        firstGroup: firstGroup,
                        secondGroup: secondGroup,
                        type: type
                    });
                } else {
                    console.log(`âŒ ç¬¬ ${i} è¡Œè·³éï¼š`, {
                        'Model æ•¸é‡': models.length,
                        'First Group æ•¸é‡': firstGroup.length,
                        'Second Group æ•¸é‡': secondGroup.length
                    });
                }
            }
            
            console.log(`\nâœ… æˆåŠŸè§£æ ${compatibilityRules.length} æ¢ç›¸ä¾ç›¸æ–¥è¦å‰‡`);
            return compatibilityRules.length;
        }

        /**
         * å®‰å…¨çš„ CSV è§£æï¼ˆè™•ç†å¼•è™Ÿå…§çš„é€—è™Ÿï¼‰
         */
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }

        /**
         * é©—è­‰å–®ä¸€é…ç½®æ˜¯å¦ç¬¦åˆç›¸ä¾ç›¸æ–¥è¦å‰‡
         * @param {Object} config - é…ç½®ç‰©ä»¶ï¼Œæ ¼å¼ï¼š{categoryName: selectedOption}
         * @param {string} productName - ç”¢å“åç¨±
         * @returns {boolean} - æ˜¯å¦æœ‰æ•ˆ
         */
        function validateConfiguration(config, productName) {
            if (compatibilityRules.length === 0) return true;

            // å–å¾—æ‰€æœ‰é¸ä¸­çš„å…ƒä»¶ï¼ˆæ’é™¤ Noneï¼‰
            const selectedComponents = new Set();
            for (const category in config) {
                const value = config[category];
                if (!value) continue;
                
                // è™•ç† Add-on å¤šé¸çš„æƒ…æ³ï¼ˆé™£åˆ—ï¼‰
                if (Array.isArray(value)) {
                    value.forEach(v => {
                        if (v && v !== 'None') {
                            selectedComponents.add(v);
                        }
                    });
                } else if (value !== 'None') {
                    // è™•ç†å–®é¸çš„æƒ…æ³ï¼ˆBase å’Œ Componentï¼‰
                    selectedComponents.add(value);
                }
            }

            // æ‰¾å‡ºé©ç”¨æ–¼æ­¤ç”¢å“çš„è¦å‰‡
            const applicableRules = compatibilityRules.filter(rule => 
                rule.models.some(model => model === productName)
            );

            if (applicableRules.length === 0) return true;

            // æª¢æŸ¥æ‰€æœ‰é©ç”¨è¦å‰‡
            for (const rule of applicableRules) {
                // æª¢æŸ¥ First Group æ˜¯å¦æœ‰ä»»ä¸€é …ç›®è¢«é¸ä¸­
                const hasFirstGroup = rule.firstGroup.some(item => selectedComponents.has(item));
                // æª¢æŸ¥ Second Group æ˜¯å¦æœ‰ä»»ä¸€é …ç›®è¢«é¸ä¸­
                const hasSecondGroup = rule.secondGroup.some(item => selectedComponents.has(item));

                if (rule.type === 'Mandatory') {
                    // ç›¸ä¾è¦å‰‡ï¼šå¦‚æœé¸äº† First Group çš„ä»»ä¸€é …ï¼Œå¿…é ˆé¸ Second Group çš„ä»»ä¸€é …
                    if (hasFirstGroup && !hasSecondGroup) {
                        return false; // é•åç›¸ä¾è¦å‰‡
                    }
                } else if (rule.type === 'Incompatible') {
                    // äº’æ–¥è¦å‰‡ï¼šFirst Group å’Œ Second Group ä¸èƒ½åŒæ™‚è¢«é¸æ“‡ï¼ˆé›™å‘äº’æ–¥ï¼‰
                    if (hasFirstGroup && hasSecondGroup) {
                        return false; // é•åäº’æ–¥è¦å‰‡
                    }
                }
            }

            return true;
        }

        /**
         * è¨ˆç®—æœ‰æ•ˆé…ç½®æ•¸é‡ï¼ˆä½¿ç”¨ç¬›å¡çˆ¾ç©æšèˆ‰ï¼‰
         * @param {Array} categoryArrays - é¡åˆ¥é¸é …é™£åˆ— [{name, options}, ...]
         * @param {string} productName - ç”¢å“åç¨±
         * @returns {number} - æœ‰æ•ˆé…ç½®æ•¸é‡
         */
        function calculateValidConfigurations(categoryArrays, productName) {
            if (compatibilityRules.length === 0) {
                // æ²’æœ‰è¦å‰‡æ™‚ï¼Œè¿”å›ç†è«–æœ€å¤§å€¼
                let total = 1;
                categoryArrays.forEach(cat => {
                    if (COLUMN_DEFINITIONS.ADD_ON.includes(cat.name)) {
                        // Add-on æ˜¯ 2^n çµ„åˆ
                        const nonNoneOptions = cat.options.filter(opt => opt !== 'None');
                        total *= Math.pow(2, nonNoneOptions.length);
                    } else {
                        total *= cat.options.length;
                    }
                });
                return total;
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰é©ç”¨çš„è¦å‰‡
            const applicableRules = compatibilityRules.filter(rule => 
                rule.models.some(model => model === productName)
            );
            
            console.log(`\nğŸ“Š è¨ˆç®— ${productName} çš„æœ‰æ•ˆé…ç½®ï¼š`);
            console.log(`  ç¸½è¦å‰‡æ•¸: ${compatibilityRules.length}`);
            console.log(`  é©ç”¨è¦å‰‡æ•¸: ${applicableRules.length}`);
            
            if (applicableRules.length > 0) {
                console.log(`  è¦å‰‡è©³æƒ…:`, applicableRules.map(r => ({
                    type: r.type,
                    first: r.firstGroup,
                    second: r.secondGroup
                })));
            } else if (compatibilityRules.length > 0) {
                // é™¤éŒ¯ï¼šé¡¯ç¤ºç‚ºä»€éº¼æ²’æœ‰åŒ¹é…
                console.log(`  âš ï¸ æ²’æœ‰é©ç”¨çš„è¦å‰‡ï¼`);
                console.log(`  ç”¢å“åç¨±: "${productName}"`);
                console.log(`  è¦å‰‡ä¸­çš„ç”¢å“ç¯„ä¾‹:`, compatibilityRules[0].models.slice(0, 3));
            }

            // æœ‰è¦å‰‡æ™‚ï¼Œéœ€è¦æšèˆ‰æ‰€æœ‰é…ç½®ä¸¦é©—è­‰
            let validCount = 0;
            let totalCount = 0;
            let invalidReasons = {};
            
            // æº–å‚™éè¿´æšèˆ‰çš„å‡½æ•¸
            function enumerateConfigs(index, currentConfig) {
                if (index === categoryArrays.length) {
                    // åˆ°é”è‘‰ç¯€é»ï¼Œé©—è­‰é…ç½®
                    totalCount++;
                    const isValid = validateConfiguration(currentConfig, productName);
                    if (isValid) {
                        validCount++;
                    } else {
                        // è¨˜éŒ„ç„¡æ•ˆåŸå› ï¼ˆç”¨æ–¼é™¤éŒ¯ï¼‰
                        const configStr = JSON.stringify(currentConfig);
                        if (!invalidReasons[configStr]) {
                            invalidReasons[configStr] = true;
                        }
                    }
                    return;
                }

                const category = categoryArrays[index];
                
                if (COLUMN_DEFINITIONS.ADD_ON.includes(category.name)) {
                    // Add-on é¡åˆ¥ï¼šæšèˆ‰æ‰€æœ‰å­é›†ï¼ˆ2^n çµ„åˆï¼‰
                    const nonNoneOptions = category.options.filter(opt => opt !== 'None');
                    const subsetCount = Math.pow(2, nonNoneOptions.length);
                    
                    for (let i = 0; i < subsetCount; i++) {
                        const subset = [];
                        for (let j = 0; j < nonNoneOptions.length; j++) {
                            if (i & (1 << j)) {
                                subset.push(nonNoneOptions[j]);
                            }
                        }
                        
                        const newConfig = {...currentConfig};
                        newConfig[category.name] = subset.length > 0 ? subset : ['None'];
                        enumerateConfigs(index + 1, newConfig);
                    }
                } else {
                    // Base æˆ– Component é¡åˆ¥ï¼šå–®é¸
                    category.options.forEach(option => {
                        const newConfig = {...currentConfig};
                        newConfig[category.name] = option;
                        enumerateConfigs(index + 1, newConfig);
                    });
                }
            }

            enumerateConfigs(0, {});
            
            console.log(`  æšèˆ‰ç¸½æ•¸: ${totalCount}, æœ‰æ•ˆé…ç½®: ${validCount}, éæ¿¾ç‡: ${((1 - validCount/totalCount) * 100).toFixed(1)}%`);
            
            return validCount;
        }

        // ==================== æ ¸å¿ƒé‚è¼¯ ====================

        /**
         * è™•ç†æª”æ¡ˆï¼ˆçµ±ä¸€å…¥å£ï¼‰
         */
        function handleFile(file) {
            if (!file) {
                showError('æœªé¸æ“‡æª”æ¡ˆ');
                return;
            }

            // é©—è­‰æª”æ¡ˆé¡å‹
            if (!file.name.endsWith('.csv')) {
                showError('è«‹ä¸Šå‚³ CSV æ ¼å¼çš„æª”æ¡ˆ');
                return;
            }

            hideError();
            loadingIndicator.classList.remove('hidden');

            // æ¨¡æ“¬éåŒæ­¥è™•ç†
            setTimeout(() => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csvText = e.target.result;
                        parseCSV(csvText);
                        runAllAnalyses();
                        renderUI();
                        loadingIndicator.classList.add('hidden');
                        
                        // æ”¶åˆæ‹–æ”¾å€åŸŸä¸¦é¡¯ç¤ºæª”æ¡ˆåç¨±
                        dropZone.classList.add('collapsed');
                        uploadedFileName.textContent = file.name;
                    } catch (error) {
                        console.error("è™•ç† CSV æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                        showError(`æª”æ¡ˆè™•ç†å¤±æ•—ï¼š${error.message}`);
                        loadingIndicator.classList.add('hidden');
                    }
                };
                reader.onerror = () => {
                    showError('æª”æ¡ˆè®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢º');
                    loadingIndicator.classList.add('hidden');
                };
                reader.readAsText(file, 'UTF-8');
            }, 100);
        }

        /**
         * è™•ç†ç›¸ä¾ç›¸æ–¥è¦å‰‡æª”æ¡ˆä¸Šå‚³
         */
        compatibilityFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.csv')) {
                showError('è«‹ä¸Šå‚³ CSV æ ¼å¼çš„ç›¸ä¾ç›¸æ–¥è¦å‰‡è¡¨');
                compatibilityFileStatus.textContent = '';
                return;
            }

            compatibilityFileStatus.innerHTML = '<span class="text-blue-600">â³ æ­£åœ¨è¼‰å…¥...</span>';

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const csvText = e.target.result;
                    const ruleCount = parseCompatibilityRules(csvText);
                    compatibilityFileStatus.innerHTML = `<span class="text-green-600">âœ“ å·²è¼‰å…¥ ${ruleCount} æ¢è¦å‰‡ï¼Œæ­£åœ¨é‡æ–°è¨ˆç®—...</span>`;
                    
                    // å¦‚æœå·²ç¶“æœ‰ç”¢å“è³‡æ–™ï¼Œé‡æ–°åŸ·è¡Œåˆ†æ
                    if (Object.keys(allProductsData).length > 0) {
                        console.log('\nğŸ”„ é‡æ–°è¨ˆç®—æ‰€æœ‰ç”¢å“çš„æœ‰æ•ˆçµ„æ…‹æ•¸é‡...');
                        loadingIndicator.classList.remove('hidden');
                        
                        // ä½¿ç”¨ setTimeout è®“ UI æœ‰æ™‚é–“æ›´æ–°
                        setTimeout(() => {
                            runAllAnalyses();
                            renderUI();
                            loadingIndicator.classList.add('hidden');
                            compatibilityFileStatus.innerHTML = `<span class="text-green-600">âœ“ å·²å¥—ç”¨ ${ruleCount} æ¢è¦å‰‡</span>`;
                            
                            // è‡ªå‹•åˆ‡æ›åˆ°ç¸½è¦½é é¢ä»¥é¡¯ç¤ºæ›´æ–°å¾Œçš„çµæœ
                            switchTab('overview');
                        }, 100);
                    } else {
                        compatibilityFileStatus.innerHTML = `<span class="text-green-600">âœ“ å·²è¼‰å…¥ ${ruleCount} æ¢è¦å‰‡</span>`;
                    }
                } catch (error) {
                    console.error("è™•ç†ç›¸ä¾ç›¸æ–¥è¦å‰‡è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                    showError(`è¦å‰‡è¡¨è™•ç†å¤±æ•—ï¼š${error.message}`);
                    compatibilityFileStatus.innerHTML = '<span class="text-red-600">âœ— è¼‰å…¥å¤±æ•—</span>';
                }
            };
            reader.onerror = () => {
                showError('è¦å‰‡è¡¨è®€å–å¤±æ•—');
                compatibilityFileStatus.innerHTML = '<span class="text-red-600">âœ— è®€å–å¤±æ•—</span>';
            };
            reader.readAsText(file, 'UTF-8');
        });

        /**
         * è™•ç†æª”æ¡ˆä¸Šå‚³ï¼ˆé»æ“Šé¸æ“‡ï¼‰
         */
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            handleFile(file);
        });

        /**
         * æ‹–æ”¾å€åŸŸäº‹ä»¶ç›£è½å™¨
         */
        // é˜²æ­¢ç€è¦½å™¨é è¨­è¡Œç‚º
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // æ‹–æ”¾è¦–è¦ºæ•ˆæœ
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.add('drag-over');
            }, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.remove('drag-over');
            }, false);
        });

        // è™•ç†æ”¾ä¸‹æª”æ¡ˆ
        dropZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }, false);

        // é»æ“Šæ‹–æ”¾å€åŸŸè§¸ç™¼æª”æ¡ˆé¸æ“‡
        dropZone.addEventListener('click', (e) => {
            // é¿å…é»æ“Š label æ™‚é‡è¤‡è§¸ç™¼
            if (e.target.tagName !== 'LABEL' && e.target.tagName !== 'INPUT') {
                // å¦‚æœæ˜¯æ”¶åˆç‹€æ…‹ï¼Œé‡ç½® input ä»¥å…è¨±é‡æ–°ä¸Šå‚³ç›¸åŒæª”æ¡ˆ
                if (dropZone.classList.contains('collapsed')) {
                    fileInput.value = '';
                }
                fileInput.click();
            }
        });

        /**
         * è§£æ CSV æª”æ¡ˆ
         */
        function parseCSV(csvText) {
            allProductsData = {};
            rawCSVData = [];

            const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== '');
            if (lines.length < 2) {
                throw new Error("CSV æª”æ¡ˆç‚ºç©ºæˆ–åªæœ‰æ¨™é ­ï¼Œè«‹ç¢ºèªæª”æ¡ˆå…§å®¹");
            }

            // è§£ææ¨™é ­
            const headers = parseCSVLine(lines[0]);
            const productColIndex = headers.findIndex(h => h.trim() === COLUMN_DEFINITIONS.PRODUCT_KEY);
            
            if (productColIndex === -1) {
                throw new Error(`CSV ä¸­ç¼ºå°‘å¿…è¦æ¬„ä½ï¼š${COLUMN_DEFINITIONS.PRODUCT_KEY}`);
            }

            // å»ºç«‹æ¬„ä½ç´¢å¼•æ˜ å°„
            const categoryCols = [
                ...COLUMN_DEFINITIONS.BASE,
                ...COLUMN_DEFINITIONS.COMPONENT,
                ...COLUMN_DEFINITIONS.ADD_ON
            ];

            const colIndices = {};
            categoryCols.forEach(colName => {
                const index = headers.findIndex(h => h.trim() === colName);
                if (index > -1) {
                    colIndices[colName] = index;
                }
            });

            // è§£æè³‡æ–™è¡Œ
            let validRowCount = 0;
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const productName = values[productColIndex]?.trim();

                if (!productName || isEmpty(productName)) continue;

                validRowCount++;

                // åˆå§‹åŒ–ç”¢å“è³‡æ–™çµæ§‹
                if (!allProductsData[productName]) {
                    allProductsData[productName] = {};
                }

                // å„²å­˜åŸå§‹è³‡æ–™
                const rowData = { product: productName };
                for (const colName in colIndices) {
                    const colIndex = colIndices[colName];
                    const value = values[colIndex]?.trim();
                    rowData[colName] = isEmpty(value) ? null : value;
                }
                rawCSVData.push(rowData);

                // è’é›†å”¯ä¸€é¸é …
                for (const colName in colIndices) {
                    const colIndex = colIndices[colName];
                    const value = values[colIndex]?.trim();

                    if (!isEmpty(value)) {
                        if (!allProductsData[productName][colName]) {
                            allProductsData[productName][colName] = new Set();
                        }
                        allProductsData[productName][colName].add(value);
                    }
                }
            }

            if (validRowCount === 0) {
                throw new Error("CSV æª”æ¡ˆä¸­æ²’æœ‰æœ‰æ•ˆçš„ç”¢å“è³‡æ–™");
            }

            console.log(`æˆåŠŸè§£æ ${validRowCount} è¡Œè³‡æ–™ï¼Œå…± ${Object.keys(allProductsData).length} å€‹ç”¢å“`);
        }

        /**
         * åŸ·è¡Œæ‰€æœ‰åˆ†æ
         */
        function runAllAnalyses() {
            productConfigAnalysis = [];
            const componentUsage = {};

            // åˆ†ææ¯å€‹ç”¢å“çš„è¤‡é›œåº¦
            for (const productName in allProductsData) {
                const categories = allProductsData[productName];
                let totalCombinations = 1;
                const detailedChoices = [];
                const categoryArrays = [];

                for (const colName in categories) {
                    const optionsSet = categories[colName];
                    if (optionsSet.size === 0) continue;

                    const options = Array.from(optionsSet).sort();
                    let categoryType = '';
                    let rule = '';
                    let finalOptions = [];
                    let choiceCount = 0;

                    if (COLUMN_DEFINITIONS.BASE.includes(colName)) {
                        categoryType = 'Base';
                        rule = 'å¿…é¸';
                        finalOptions = options;
                        choiceCount = options.length;
                    } else if (COLUMN_DEFINITIONS.COMPONENT.includes(colName)) {
                        categoryType = 'Component';
                        rule = 'å¯é¸';
                        finalOptions = [...options, 'None'];
                        choiceCount = options.length + 1;
                    } else if (COLUMN_DEFINITIONS.ADD_ON.includes(colName)) {
                        categoryType = 'Add-on';
                        rule = 'å¤šé¸';
                        finalOptions = [...options, 'None'];
                        // Add-on å¯ä»¥å¤šé¸ï¼šåŒ…å«ã€Œç„¡ã€é¸é …ï¼ŒåŠ ä¸Šæ‰€æœ‰å¯èƒ½çš„é…ä»¶çµ„åˆ
                        // å¯ä»¥é¸æ“‡ï¼šç„¡ã€å–®å€‹é…ä»¶ã€å¤šå€‹é…ä»¶çš„ä»»æ„çµ„åˆ
                        choiceCount = Math.pow(2, options.length);
                    }

                    if (choiceCount > 0) {
                        totalCombinations *= choiceCount;
                        detailedChoices.push({
                            category: colName,
                            categoryType: categoryType,
                            rule: rule,
                            count: choiceCount,
                            options: finalOptions
                        });
                        categoryArrays.push({
                            name: colName,
                            options: finalOptions
                        });
                    }

                    // è’é›†å…ƒä»¶é€šç”¨æ€§è³‡æ–™
                    options.forEach(opt => {
                        if (!componentUsage[opt]) {
                            componentUsage[opt] = {
                                products: new Set(),
                                categories: new Set()
                            };
                        }
                        componentUsage[opt].products.add(productName);
                        componentUsage[opt].categories.add(colName);
                    });
                }

                // è¨ˆç®—æœ‰æ•ˆé…ç½®æ•¸é‡ï¼ˆè€ƒæ…®ç›¸ä¾ç›¸æ–¥è¦å‰‡ï¼‰
                const validCount = calculateValidConfigurations(categoryArrays, productName);

                // è¨ˆç®—åŸºç¤çµ„æ…‹æ•¸é‡ï¼ˆæ’é™¤ Add-onï¼‰
                let baseCombinations = 1;
                detailedChoices.forEach(choice => {
                    if (!COLUMN_DEFINITIONS.ADD_ON.includes(choice.category)) {
                        baseCombinations *= choice.count;
                    }
                });

                productConfigAnalysis.push({
                    name: productName,
                    count: validCount, // ä½¿ç”¨éæ¿¾å¾Œçš„æœ‰æ•ˆé…ç½®æ•¸
                    theoreticalCount: totalCombinations, // ä¿ç•™ç†è«–æœ€å¤§å€¼ä¾›åƒè€ƒ
                    baseCount: baseCombinations, // åŸºç¤çµ„æ…‹æ•¸é‡ï¼ˆä¸å« Add-onï¼‰
                    details: detailedChoices,
                    categoryArrays: categoryArrays
                });
            }

            // æ’åºç”¢å“è¤‡é›œåº¦
            productConfigAnalysis.sort((a, b) => b.count - a.count);

            // æ•´ç†å…ƒä»¶é€šç”¨æ€§çµæœ
            componentCommonality = [];
            for (const componentName in componentUsage) {
                const data = componentUsage[componentName];
                componentCommonality.push({
                    name: componentName,
                    count: data.products.size,
                    products: Array.from(data.products).sort(),
                    categories: Array.from(data.categories).sort()
                });
            }

            // æ’åºå…ƒä»¶é€šç”¨æ€§
            componentCommonality.sort((a, b) => b.count - a.count);

            console.log(`åˆ†æå®Œæˆï¼š${productConfigAnalysis.length} å€‹ç”¢å“ï¼Œ${componentCommonality.length} å€‹å…ƒä»¶`);
        }

        /**
         * æ¸²æŸ“ UI
         */
        function renderUI() {
            loadingIndicator.classList.add('hidden');
            analysisContent.classList.remove('hidden');
            statsBadge.classList.remove('hidden');

            // æ›´æ–°çµ±è¨ˆå¾½ç« 
            productCountSpan.textContent = productConfigAnalysis.length;
            componentCountSpan.textContent = componentCommonality.length;

            // é è¨­é¡¯ç¤ºç¸½è¦½
            renderOverviewTab();
        }

        // ==================== æ¸²æŸ“å„åˆ†é  ====================

        /**
         * æ¸²æŸ“ç¸½è¦½åˆ†é 
         */
        function renderOverviewTab() {
            const totalConfigs = productConfigAnalysis.reduce((sum, p) => sum + p.count, 0);
            const totalTheoretical = productConfigAnalysis.reduce((sum, p) => sum + (p.theoreticalCount || p.count), 0);
            const totalBase = productConfigAnalysis.reduce((sum, p) => sum + (p.baseCount || 0), 0);
            const mostComplex = productConfigAnalysis[0];
            const leastComplex = productConfigAnalysis[productConfigAnalysis.length - 1];
            const mostCommon = componentCommonality[0];

            // è¨ˆç®—ç”¢å“ç³»åˆ—æ•¸é‡ï¼ˆæ ¹æ“šç¬¬ä¸€å€‹ "-" å‰çš„å‰ç¶´ï¼‰
            const productSeries = new Set();
            productConfigAnalysis.forEach(product => {
                const seriesPrefix = product.name.split('-')[0];
                if (seriesPrefix) {
                    productSeries.add(seriesPrefix);
                }
            });

            // ç›¸ä¾ç›¸æ–¥è¦å‰‡çµ±è¨ˆ
            const mandatoryCount = compatibilityRules.filter(r => r.type === 'Mandatory').length;
            const incompatibleCount = compatibilityRules.filter(r => r.type === 'Incompatible').length;
            const hasRules = compatibilityRules.length > 0;
            const filtered = hasRules && totalTheoretical > totalConfigs;
            const filterRate = filtered ? ((1 - totalConfigs / totalTheoretical) * 100).toFixed(1) : 0;

            const html = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-slate-600 mb-2">ç”¢å“ç¸½æ•¸</h3>
                        <p class="text-3xl font-bold text-slate-800">${productConfigAnalysis.length}</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-slate-600 mb-2">å…ƒä»¶ç¸½æ•¸</h3>
                        <p class="text-3xl font-bold text-slate-800">${componentCommonality.length}</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-slate-600 mb-2">${filtered ? 'æœ‰æ•ˆçµ„æ…‹æ•¸é‡' : 'ç¸½çµ„æ…‹æ•¸é‡'}</h3>
                        <p class="text-3xl font-bold ${filtered ? 'text-green-600' : 'text-slate-800'}">${totalConfigs.toLocaleString()}</p>
                        ${totalBase > 0 ? `<p class="text-xs text-slate-500 mt-1">åŸºç¤çµ„æ…‹ï¼š${totalBase.toLocaleString()}</p>` : ''}
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-slate-600 mb-2">ç”¢å“ç³»åˆ—</h3>
                        <p class="text-3xl font-bold text-slate-800">${productSeries.size}</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-slate-600 mb-2">æœ€è¤‡é›œç”¢å“</h3>
                        <p class="text-lg font-semibold text-slate-800 truncate" title="${mostComplex?.name}">${mostComplex?.name || 'N/A'}</p>
                        <p class="text-sm text-slate-500">${(mostComplex?.count || 0).toLocaleString()} ç¨®çµ„æ…‹</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-slate-600 mb-2">æœ€é€šç”¨å…ƒä»¶</h3>
                        <p class="text-lg font-semibold text-slate-800 truncate" title="${mostCommon?.name}">${mostCommon?.name || 'N/A'}</p>
                        <p class="text-sm text-slate-500">è¢« ${mostCommon?.count || 0} å€‹ç”¢å“ä½¿ç”¨</p>
                    </div>
                </div>

                ${hasRules ? `
                <div class="bg-gradient-to-r from-purple-50 to-indigo-50 p-6 rounded-lg shadow mb-6 border border-purple-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-slate-800 mb-2">ç›¸ä¾ç›¸æ–¥è¦å‰‡ ${filtered ? 'âœ“ å·²å¥—ç”¨' : ''}</h3>
                            <p class="text-sm text-slate-600 mb-3">å·²è¼‰å…¥ ${compatibilityRules.length} æ¢è¦å‰‡${filtered ? `ï¼Œéæ¿¾æ‰ ${(totalTheoretical - totalConfigs).toLocaleString()} å€‹ç„¡æ•ˆçµ„æ…‹ (${filterRate}%)` : ''}</p>
                            <div class="flex gap-4">
                                <div class="flex items-center gap-2">
                                    <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                                    <span class="text-sm text-slate-700">${mandatoryCount} æ¢ç›¸ä¾è¦å‰‡</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                                    <span class="text-sm text-slate-700">${incompatibleCount} æ¢ç›¸æ–¥è¦å‰‡</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="switchTab('compatibility')" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors text-sm font-medium">
                            æŸ¥çœ‹è©³æƒ…
                        </button>
                    </div>
                </div>
                ` : ''}

                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">ç”¢å“ç³»åˆ—</h3>
                    <div class="flex flex-wrap gap-2">
                        ${Array.from(productSeries).sort().map(series => `
                            <span class="px-3 py-1.5 bg-indigo-50 text-indigo-700 rounded-full text-sm font-medium border border-indigo-200">
                                ${series}
                            </span>
                        `).join('')}
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow mb-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">ç”¢å“çµ„æ…‹æ’è¡Œ</h3>
                    <div class="space-y-2">
                        ${productConfigAnalysis.slice(0, 5).map((product, index) => {
                            const percentage = (product.count / mostComplex.count) * 100;
                            return `
                                <div>
                                    <div class="flex justify-between text-sm mb-1">
                                        <span class="font-medium text-slate-700">${product.name}</span>
                                        <span class="text-slate-600">${product.count.toLocaleString()}</span>
                                    </div>
                                    <div class="w-full bg-slate-200 rounded-full h-2">
                                        <div class="bg-indigo-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            tabContent.innerHTML = html;
        }

        /**
         * æ¸²æŸ“ç”¢å“è¤‡é›œåº¦åˆ†é 
         */
        function renderComplexityTab() {
            const html = `
                <div class="mb-4 bg-white p-4 rounded-lg shadow">
                    <h3 class="text-lg font-semibold text-slate-800 mb-2">ç”¢å“çµ„æ…‹è¤‡é›œåº¦æ’è¡Œæ¦œ</h3>
                    <p class="text-sm text-slate-600">å±•ç¤ºæ¯å€‹ç”¢å“å¯èƒ½çš„çµ„æ…‹æ•¸é‡ï¼ˆé»æ“ŠæŸ¥çœ‹è©³æƒ…ï¼‰</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${productConfigAnalysis.map((product, index) => {
                        const rankColor = index === 0 ? 'bg-yellow-100 text-yellow-700' : 
                                        index === 1 ? 'bg-slate-200 text-slate-700' : 
                                        index === 2 ? 'bg-orange-100 text-orange-700' : 
                                        'bg-indigo-100 text-indigo-600';
                        return `
                            <button 
                                class="product-item-button bg-white p-4 rounded-lg shadow text-left hover:shadow-lg hover:scale-105 transition-all"
                                data-product-name="${product.name}"
                            >
                                <div class="flex items-center space-x-3">
                                    <span class="flex-shrink-0 w-10 h-10 rounded-full ${rankColor} font-bold flex items-center justify-center text-sm">
                                        ${index + 1}
                                    </span>
                                    <div class="flex-1 min-w-0">
                                        <p class="font-semibold text-slate-800 truncate" title="${product.name}">${product.name}</p>
                                        <p class="text-sm text-slate-500">${product.count.toLocaleString()} ç¨®çµ„æ…‹</p>
                                        <p class="text-xs text-slate-400">${product.details.length} å€‹é¡åˆ¥ | ${(product.baseCount || 0).toLocaleString()} ç¨®åŸºç¤çµ„æ…‹</p>
                                    </div>
                                </div>
                            </button>
                        `;
                    }).join('')}
                </div>
            `;
            tabContent.innerHTML = html;
        }

        /**
         * æ¸²æŸ“å…ƒä»¶é€šç”¨æ€§åˆ†é 
         */
        function renderCommonalityTab() {
            // åˆå§‹æ’åºç‹€æ…‹
            if (!window.componentSortState) {
                window.componentSortState = {
                    column: 'count', // é è¨­æŒ‰ä½¿ç”¨ç”¢å“æ•¸æ’åº
                    order: 'desc'
                };
            }
            
            const html = `
                <div class="mb-4 bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-slate-800 mb-2">å…ƒä»¶é€šç”¨æ€§åˆ†æ</h3>
                            <p class="text-sm text-slate-600">çµ±è¨ˆæ¯å€‹å…ƒä»¶è¢«å¤šå°‘å€‹ä¸åŒç”¢å“æ‰€ä½¿ç”¨ï¼ˆé»æ“Šè¡¨é ­å¯æ’åºï¼‰</p>
                        </div>
                        <button id="open-component-search" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors shadow flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            å­å…ƒä»¶æŸ¥è©¢
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">æ’å</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-100 transition-colors" onclick="sortComponentTable('name')">
                                        <div class="flex items-center gap-2">
                                            å…ƒä»¶æ–™è™Ÿ
                                            <span class="sort-indicator ${window.componentSortState.column === 'name' ? 'active' : ''}">${window.componentSortState.column === 'name' ? (window.componentSortState.order === 'asc' ? 'â–²' : 'â–¼') : 'â‡…'}</span>
                                        </div>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ä½¿ç”¨é¡åˆ¥</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-100 transition-colors" onclick="sortComponentTable('count')">
                                        <div class="flex items-center gap-2">
                                            ä½¿ç”¨ç”¢å“æ•¸
                                            <span class="sort-indicator ${window.componentSortState.column === 'count' ? 'active' : ''}">${window.componentSortState.column === 'count' ? (window.componentSortState.order === 'asc' ? 'â–²' : 'â–¼') : 'â‡…'}</span>
                                        </div>
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ç”¢å“ç¯„ä¾‹</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-slate-200" id="component-table-body">
                                ${getSortedComponents().map((component, index) => `
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${index + 1}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <p class="text-sm font-medium text-slate-900">${component.name}</p>
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="flex flex-wrap gap-1">
                                                ${component.categories.map(cat => `
                                                    <span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded">${cat}</span>
                                                `).join('')}
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="text-sm font-semibold text-indigo-600 bg-indigo-50 py-1 px-3 rounded-full">
                                                ${component.count} å€‹
                                            </span>
                                        </td>
                                        <td class="px-6 py-4">
                                            <p class="text-sm text-slate-500 truncate max-w-xs" title="${component.products.join(', ')}">
                                                ${component.products.slice(0, 2).join(', ')}${component.products.length > 2 ? '...' : ''}
                                            </p>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            tabContent.innerHTML = html;
            
            // ç¶å®šæŒ‰éˆ•äº‹ä»¶
            document.getElementById('open-component-search').addEventListener('click', openComponentSearchModal);
        }

        /**
         * å–å¾—æ’åºå¾Œçš„å…ƒä»¶åˆ—è¡¨
         */
        function getSortedComponents() {
            const sorted = [...componentCommonality];
            const state = window.componentSortState;
            
            sorted.sort((a, b) => {
                let compareValue = 0;
                
                if (state.column === 'name') {
                    compareValue = a.name.localeCompare(b.name);
                } else if (state.column === 'count') {
                    compareValue = a.count - b.count;
                }
                
                return state.order === 'asc' ? compareValue : -compareValue;
            });
            
            return sorted;
        }

        /**
         * æ’åºå…ƒä»¶è¡¨æ ¼
         */
        window.sortComponentTable = function(column) {
            const state = window.componentSortState;
            
            // å¦‚æœé»æ“ŠåŒä¸€æ¬„ä½ï¼Œåˆ‡æ›æ’åºé †åºï¼›å¦å‰‡ä½¿ç”¨é è¨­é †åº
            if (state.column === column) {
                state.order = state.order === 'asc' ? 'desc' : 'asc';
            } else {
                state.column = column;
                state.order = column === 'count' ? 'desc' : 'asc'; // æ•¸é‡é è¨­é™åºï¼Œåç¨±é è¨­å‡åº
            }
            
            // é‡æ–°æ¸²æŸ“è¡¨æ ¼
            renderCommonalityTab();
        };

        /**
         * æ¸²æŸ“ç›¸ä¾ç›¸æ–¥è¦å‰‡åˆ†é 
         */
        function renderCompatibilityTab() {
            if (compatibilityRules.length === 0) {
                tabContent.innerHTML = `
                    <div class="bg-white p-12 rounded-lg shadow text-center">
                        <svg class="mx-auto h-16 w-16 text-slate-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p class="text-lg font-medium text-slate-700 mb-2">å°šæœªè¼‰å…¥ç›¸ä¾ç›¸æ–¥è¦å‰‡è¡¨</p>
                        <p class="text-sm text-slate-500">è«‹é»æ“Šä¸Šæ–¹çš„ã€ŒåŒ¯å…¥ç›¸ä¾ç›¸æ–¥è¦å‰‡è¡¨ã€æŒ‰éˆ•ä¾†è¼‰å…¥è¦å‰‡</p>
                    </div>
                `;
                return;
            }

            // çµ±è¨ˆè¦å‰‡é¡å‹
            const mandatoryRules = compatibilityRules.filter(r => r.type === 'Mandatory');
            const incompatibleRules = compatibilityRules.filter(r => r.type === 'Incompatible');

            // çµ±è¨ˆå½±éŸ¿çš„ç”¢å“æ•¸é‡
            const affectedProducts = new Set();
            compatibilityRules.forEach(rule => {
                rule.models.forEach(model => affectedProducts.add(model));
            });

            const html = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-slate-600 mb-2">ç¸½è¦å‰‡æ•¸</h3>
                        <p class="text-3xl font-bold text-slate-800">${compatibilityRules.length}</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-slate-600 mb-2">ç›¸ä¾è¦å‰‡ (Mandatory)</h3>
                        <p class="text-3xl font-bold text-green-600">${mandatoryRules.length}</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-sm font-medium text-slate-600 mb-2">ç›¸æ–¥è¦å‰‡ (Incompatible)</h3>
                        <p class="text-3xl font-bold text-red-600">${incompatibleRules.length}</p>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg shadow mb-6">
                    <h3 class="text-lg font-semibold text-slate-800 mb-2">è¦å‰‡èªªæ˜</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div class="border-l-4 border-green-500 pl-4">
                            <p class="font-medium text-green-700 mb-1">Mandatory (ç›¸ä¾)</p>
                            <p class="text-slate-600">å¦‚æœé¸æ“‡äº† First Group ä¸­çš„<strong>ä»»ä¸€é …ç›®</strong>ï¼Œå‰‡<strong>å¿…é ˆ</strong>é¸æ“‡ Second Group ä¸­çš„<strong>ä»»ä¸€é …ç›®</strong></p>
                            <p class="text-xs text-slate-500 mt-1">é‚è¼¯ï¼šFirst Group (OR) â†’ Second Group (è‡³å°‘é¸ä¸€)</p>
                        </div>
                        <div class="border-l-4 border-red-500 pl-4">
                            <p class="font-medium text-red-700 mb-1">Incompatible (ç›¸æ–¥)</p>
                            <p class="text-slate-600">First Group å’Œ Second Group <strong>ä¸èƒ½åŒæ™‚é¸æ“‡</strong>ã€‚åªèƒ½é¸æ“‡å…¶ä¸­ä¸€çµ„ï¼Œæˆ–å…©çµ„éƒ½ä¸é¸</p>
                            <p class="text-xs text-slate-500 mt-1">é‚è¼¯ï¼šFirst Group âŠ• Second Group (äº’æ–¥ï¼Œé›™å‘é™åˆ¶)</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="p-4 bg-slate-50 border-b border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-800">è¦å‰‡åˆ—è¡¨</h3>
                        <p class="text-sm text-slate-600 mt-1">å…± ${compatibilityRules.length} æ¢è¦å‰‡</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">#</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">è¦å‰‡é¡å‹</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">First Group (æ¢ä»¶)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Second Group (çµæœ)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">é©ç”¨ç”¢å“</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-slate-200">
                                ${compatibilityRules.map((rule, index) => {
                                    const typeColor = rule.type === 'Mandatory' ? 'green' : 'red';
                                    const typeLabel = rule.type === 'Mandatory' ? 'ç›¸ä¾' : 'ç›¸æ–¥';
                                    return `
                                        <tr class="hover:bg-slate-50">
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${index + 1}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="px-3 py-1 text-xs font-medium rounded-full bg-${typeColor}-100 text-${typeColor}-700">
                                                    ${typeLabel}
                                                </span>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="flex flex-wrap gap-1">
                                                    ${rule.firstGroup.map(item => `
                                                        <span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-200">${item}</span>
                                                    `).join('')}
                                                </div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <div class="flex flex-wrap gap-1">
                                                    ${rule.secondGroup.map(item => `
                                                        <span class="text-xs bg-purple-50 text-purple-700 px-2 py-1 rounded border border-purple-200">${item}</span>
                                                    `).join('')}
                                                </div>
                                            </td>
                                            <td class="px-6 py-4">
                                                <p class="text-sm text-slate-600 truncate max-w-xs" title="${rule.models.join(', ')}">
                                                    ${rule.models.length > 2 ? `${rule.models.slice(0, 2).join(', ')}... (+${rule.models.length - 2})` : rule.models.join(', ')}
                                                </p>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            tabContent.innerHTML = html;
        }

        /**
         * æ¸²æŸ“åå‘å…ƒä»¶æŸ¥è©¢åˆ†é 
         */
        function renderReverseSearchTab() {
            // æ­¤åŠŸèƒ½å·²ç§»è‡³å…ƒä»¶é€šç”¨æ€§åˆ†æé é¢çš„ Modal
            // ä¿ç•™æ­¤å‡½æ•¸ä»¥é˜²èˆŠä»£ç¢¼èª¿ç”¨
        }

        /**
         * é–‹å•Ÿå­å…ƒä»¶æŸ¥è©¢ Modal
         */
        function openComponentSearchModal() {
            const allComponents = componentCommonality.map(c => c.name).sort();
            
            // å¡«å……é¸æ“‡åˆ—è¡¨
            componentSearchSelect.innerHTML = '<option value="">-- è«‹é¸æ“‡å…ƒä»¶ --</option>' +
                allComponents.map(name => `<option value="${name}">${name}</option>`).join('');
            
            // æ¸…ç©ºæœå°‹
            componentSearchInput.value = '';
            componentSearchResults.innerHTML = '';
            
            componentSearchModal.classList.remove('hidden');
        }

        /**
         * é¡¯ç¤ºåå‘æŸ¥è©¢çµæœ
         */
        function displayReverseSearchResults(component, container) {
            container.innerHTML = `
                <div class="bg-slate-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-slate-800 mb-2">å…ƒä»¶è³‡è¨Š</h4>
                    <p class="text-sm text-slate-600 mb-4">
                        <span class="font-medium">${component.name}</span> è¢« 
                        <span class="font-bold text-indigo-600">${component.count}</span> å€‹ç”¢å“ä½¿ç”¨
                    </p>
                    <div class="mb-3">
                        <p class="text-sm font-medium text-slate-700 mb-2">ä½¿ç”¨é¡åˆ¥ï¼š</p>
                        <div class="flex flex-wrap gap-2">
                            ${component.categories.map(cat => `
                                <span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded">${cat}</span>
                            `).join('')}
                        </div>
                    </div>
                    <h4 class="font-semibold text-slate-800 mb-2">ä½¿ç”¨æ­¤å…ƒä»¶çš„ç”¢å“æ¸…å–®ï¼š</h4>
                    <ul class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        ${component.products.map(prod => `
                            <li class="flex items-center space-x-2 text-sm text-slate-700 bg-white p-2 rounded">
                                <svg class="h-4 w-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>${prod}</span>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }

        // ==================== äº‹ä»¶ç¶å®š ====================

        /**
         * åˆ†é åˆ‡æ›
         */
        tabContainer.addEventListener('click', (e) => {
            const button = e.target.closest('.tab-button');
            if (!button) return;

            const tabName = button.dataset.tab;
            switchTab(tabName);
        });

        window.switchTab = function(tabName) {
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            tabContainer.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('border-indigo-500', 'text-indigo-600');
                btn.classList.add('border-transparent', 'text-slate-500');
            });
            const activeButton = tabContainer.querySelector(`[data-tab="${tabName}"]`);
            if (activeButton) {
                activeButton.classList.add('border-indigo-500', 'text-indigo-600');
                activeButton.classList.remove('border-transparent', 'text-slate-500');
            }

            // æ¸²æŸ“å°æ‡‰å…§å®¹
            switch (tabName) {
                case 'overview':
                    renderOverviewTab();
                    break;
                case 'complexity':
                    renderComplexityTab();
                    break;
                case 'commonality':
                    renderCommonalityTab();
                    break;
                case 'compatibility':
                    renderCompatibilityTab();
                    break;
            }
        };

        /**
         * é¡¯ç¤ºç”¢å“è©³æƒ… Modal
         */
        function showProductModal(productName) {
            const product = productConfigAnalysis.find(p => p.name === productName);
            if (!product) return;

            modalProductName.textContent = product.name;
            
            // è¨ˆç®—é©ç”¨çš„è¦å‰‡æ•¸é‡
            const applicableRules = compatibilityRules.filter(rule => 
                rule.models.some(model => model === product.name)
            );
            const mandatoryCount = applicableRules.filter(r => r.type === 'Mandatory').length;
            const incompatibleCount = applicableRules.filter(r => r.type === 'Incompatible').length;
            
            // é¡¯ç¤ºé…ç½®æ•¸é‡
            const hasRules = applicableRules.length > 0;
            const filtered = hasRules && product.theoreticalCount > product.count;
            
            if (filtered) {
                modalProductCount.innerHTML = `
                    <span class="text-green-600 font-bold">${product.count.toLocaleString()}</span> ç¨®æœ‰æ•ˆçµ„æ…‹
                    <span class="text-slate-400 mx-2">|</span>
                    <span class="text-slate-500">åŸºç¤çµ„æ…‹ï¼š${(product.baseCount || 0).toLocaleString()}</span>
                    <span class="text-slate-400 mx-2">|</span>
                    <span class="text-purple-600">é©ç”¨ ${mandatoryCount} æ¢ç›¸ä¾${incompatibleCount > 0 ? ` / ${incompatibleCount} æ¢ç›¸æ–¥` : ''}è¦å‰‡</span>
                `;
            } else if (hasRules) {
                modalProductCount.innerHTML = `
                    <span class="font-bold">${product.count.toLocaleString()}</span> ç¨®çµ„æ…‹
                    <span class="text-slate-400 mx-2">|</span>
                    <span class="text-slate-500">åŸºç¤çµ„æ…‹ï¼š${(product.baseCount || 0).toLocaleString()}</span>
                    <span class="text-slate-400 mx-2">|</span>
                    <span class="text-purple-600">é©ç”¨ ${mandatoryCount} æ¢ç›¸ä¾${incompatibleCount > 0 ? ` / ${incompatibleCount} æ¢ç›¸æ–¥` : ''}è¦å‰‡</span>
                `;
            } else {
                modalProductCount.innerHTML = `
                    ç¸½çµ„æ…‹æ•¸é‡ï¼š<span class="font-bold">${product.count.toLocaleString()}</span> ç¨®
                    <span class="text-slate-400 mx-2">|</span>
                    <span class="text-slate-500">åŸºç¤çµ„æ…‹ï¼š${(product.baseCount || 0).toLocaleString()}</span>
                `;
            }

            // æŒ‰ç…§ categoryType åˆ†çµ„
            const groupedDetails = {
                'Base': [],
                'Component': [],
                'Add-on': []
            };

            product.details.forEach(choice => {
                if (groupedDetails[choice.categoryType]) {
                    groupedDetails[choice.categoryType].push(choice);
                }
            });

            let detailsHtml = '<div class="space-y-6">';
            
            // æ¸²æŸ“æ¯å€‹åˆ†çµ„
            ['Base', 'Component', 'Add-on'].forEach(type => {
                if (groupedDetails[type].length > 0) {
                    detailsHtml += `
                        <div>
                            <p class="text-xs text-slate-400 mb-3 uppercase tracking-wide">${type}</p>
                            <div class="space-y-4">
                                ${groupedDetails[type].map(choice => `
                                    <div class="border-l-4 ${choice.rule === 'å¿…é¸' ? 'border-red-500' : choice.rule === 'å¤šé¸' ? 'border-purple-500' : 'border-green-500'} pl-4 bg-white">
                                        <h4 class="font-semibold text-slate-800 mb-2">${choice.category}</h4>
                                        <p class="text-sm text-slate-600 mb-3">
                                            è¦å‰‡ï¼š<span class="font-medium ${choice.rule === 'å¿…é¸' ? 'text-red-600' : choice.rule === 'å¤šé¸' ? 'text-purple-600' : 'text-green-600'}">${choice.rule}</span> 
                                            ${choice.rule === 'å¤šé¸' ? `(${choice.options.length} å€‹é¸é …å¯å¤šé¸ï¼Œå…± ${choice.count} ç¨®çµ„åˆ)` : `(${choice.count} é¸ 1)`}
                                        </p>
                                        <div class="flex flex-wrap gap-2">
                                            ${choice.options.map(opt => `
                                                <span class="text-xs font-medium py-1.5 px-3 rounded-full ${opt === 'None' ? 'bg-slate-100 text-slate-600 border border-slate-300' : choice.rule === 'å¤šé¸' ? 'bg-purple-50 text-purple-700 border border-purple-200' : 'bg-blue-50 text-blue-700 border border-blue-200'}">
                                                    ${opt}
                                                </span>
                                            `).join('')}
                                        </div>
                                        ${choice.rule === 'å¤šé¸' ? '<p class="text-xs text-slate-500 mt-2">ğŸ’¡ å¯é¸æ“‡ä»»æ„æ•¸é‡çš„çµ„åˆï¼ˆåŒ…æ‹¬ã€Œç„¡ã€æˆ–å¤šå€‹é…ä»¶ï¼‰</p>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            
            detailsHtml += '</div>';

            // å¦‚æœæœ‰é©ç”¨çš„è¦å‰‡ï¼Œé¡¯ç¤ºåœ¨æœ€ä¸‹æ–¹
            if (applicableRules.length > 0) {
                detailsHtml += `
                    <div class="mt-8 pt-6 border-t border-slate-200">
                        <h3 class="text-lg font-semibold text-slate-800 mb-4">é©ç”¨çš„ç›¸ä¾ç›¸æ–¥è¦å‰‡</h3>
                        <div class="space-y-3">
                            ${applicableRules.map((rule, index) => {
                                const typeColor = rule.type === 'Mandatory' ? 'green' : 'red';
                                const typeLabel = rule.type === 'Mandatory' ? 'ç›¸ä¾ (Mandatory)' : 'äº’æ–¥ (Incompatible)';
                                const description = rule.type === 'Mandatory' 
                                    ? 'å¦‚æœé¸æ“‡ First Group ä¸­çš„ä»»ä¸€é …ï¼Œå‰‡å¿…é ˆé¸æ“‡ Second Group ä¸­çš„ä»»ä¸€é …'
                                    : 'First Group å’Œ Second Group ä¸èƒ½åŒæ™‚é¸æ“‡ï¼ˆé›™å‘äº’æ–¥ï¼‰';
                                
                                return `
                                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="text-sm font-medium text-slate-700">è¦å‰‡ ${index + 1}</span>
                                            <span class="px-3 py-1 text-xs font-medium rounded-full bg-${typeColor}-100 text-${typeColor}-700">
                                                ${typeLabel}
                                            </span>
                                        </div>
                                        <p class="text-xs text-slate-600 mb-3">${description}</p>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                            <div>
                                                <p class="text-xs font-medium text-slate-700 mb-2">First Group (æ¢ä»¶)</p>
                                                <div class="flex flex-wrap gap-1">
                                                    ${rule.firstGroup.map(item => `
                                                        <span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-200">${item}</span>
                                                    `).join('')}
                                                </div>
                                            </div>
                                            <div>
                                                <p class="text-xs font-medium text-slate-700 mb-2">Second Group (çµæœ)</p>
                                                <div class="flex flex-wrap gap-1">
                                                    ${rule.secondGroup.map(item => `
                                                        <span class="text-xs bg-purple-50 text-purple-700 px-2 py-1 rounded border border-purple-200">${item}</span>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            modalProductDetails.innerHTML = detailsHtml || '<p class="text-slate-500">æ­¤ç”¢å“æ²’æœ‰å¯é…ç½®çš„é¸é …ã€‚</p>';
            productModal.classList.remove('hidden');
        }

        // Modal é—œé–‰äº‹ä»¶
        modalCloseButton.addEventListener('click', () => productModal.classList.add('hidden'));
        productModal.addEventListener('click', (e) => {
            if (e.target === productModal) productModal.classList.add('hidden');
        });

        // å­å…ƒä»¶æŸ¥è©¢ Modal é—œé–‰äº‹ä»¶
        componentSearchModalClose.addEventListener('click', () => componentSearchModal.classList.add('hidden'));
        componentSearchModal.addEventListener('click', (e) => {
            if (e.target === componentSearchModal) componentSearchModal.classList.add('hidden');
        });

        // å­å…ƒä»¶æŸ¥è©¢ Modal å…§çš„æœå°‹äº‹ä»¶
        componentSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.trim().toLowerCase();
            if (searchTerm.length < 2) {
                componentSearchResults.innerHTML = '';
                return;
            }

            const matches = componentCommonality.filter(c => 
                c.name.toLowerCase().includes(searchTerm)
            );

            if (matches.length === 0) {
                componentSearchResults.innerHTML = '<p class="text-slate-500">æ‰¾ä¸åˆ°ç¬¦åˆçš„å…ƒä»¶</p>';
                return;
            }

            displayReverseSearchResults(matches[0], componentSearchResults);
        });

        componentSearchSelect.addEventListener('change', (e) => {
            const selectedComponent = e.target.value;
            if (!selectedComponent) {
                componentSearchResults.innerHTML = '';
                return;
            }

            const component = componentCommonality.find(c => c.name === selectedComponent);
            if (component) {
                componentSearchInput.value = '';
                displayReverseSearchResults(component, componentSearchResults);
            }
        });

        // ç”¢å“é …ç›®é»æ“Šäº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ´¾ï¼‰
        tabContent.addEventListener('click', (e) => {
            const button = e.target.closest('.product-item-button');
            if (button) {
                showProductModal(button.dataset.productName);
            }
        });

        // ESC éµé—œé–‰ Modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                productModal.classList.add('hidden');
                componentSearchModal.classList.add('hidden');
            }
        });

        // ==================== åˆå§‹åŒ– ====================
        console.log('å•†åŸçµ„æ…‹åˆ†æå·¥å…·å·²è¼‰å…¥');
    </script>
</body>
</html>
